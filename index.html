<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.2.1/backbone-min.js"></script>

        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    </head>
    <body>
        <div class="header fixed">Moments</div>
        <div id="moments_body_container"></div>
    </body>

    <style>

body {
    margin: 0;
}

#moments_body_container {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 14px;
    margin-top: 67px;
}

.header.fixed {
    height: 65px;     position: absolute;     top: 0;     width: 100%;     text-align: center;     background-color: orange;     color: white;     font-size: 36px;     box-sizing: border-box;     padding-top: 25px;
}

.moment_single {
    margin: 0 18px;
    padding: 30px 0 5px 0;
}

.heading {
    color: #9B9B9B;
}

.heading .name_container .username {
    color: black;
    letter-spacing: 1.7px;
    font-weight: 600;
    display: inline-block;
}

.heading .name_container .membername {
    color: darkgray;
    letter-spacing: 1px;
    font-weight: 600;
    display: inline-block;
}

.photos_container {
    height: 260px;
    position: absolute;
    right: 18px;
    overflow: hidden;
}

.photos_container .single_photo:not(.visible) {
    transition: transform 700ms, margin 700ms;
    position: absolute;
    right: 0;
    top: 0;
    margin: 0 -62px;
    transform: scale(0.8, 0.8);
    z-index: 0;
}

.photos_container .single_photo.animating {
    margin: 0;
    transform: scale(1, 1);
    z-index: 1;
}

.photos_container .single_photo.visible {
    display: inline-block;
    position: relative;
    z-index: 2;
}

.photos_container .single_photo img.moment_photo {
    max-height: 260px;
    max-width: 100%;
}

.single_photo .comments_container {
    display: none;
}

</style>

    <script id="tpl_moment_single" type="text/template">
        <div class="moment_single">
            <div class="heading">
                <div class="name_container">
                    <div class="username"><%- d.username %></div>
                    <% _.each(d.members, function (membername) { %>
                        <div class="membername"><%- membername %></div>
                    <% }); %>
                </div>
                <div class="moment_meta"><%- d.location_name %>, <%- d.posted_on %></div>
                <div class="description"><%- d.description %></div>
            </div>
            <div class="photos_container">
                <% _.each(d.photos, function (photo) { %>
                    <div class="single_photo">
                        <img class="moment_photo" src="<%- photo.src %>">
                        <div class="comments_container">
                            <div class="snap_count"><%- photo.snaps %></div>
                            <% _.each(photo.comments, function (comment) { %>
                                <div class="comment">
                                    <div class="username"><%- comment.username %></div>
                                    <%- comment.comment %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    </script>

    <script type="text/javascript">
        var MomentsView = Backbone.View.extend({

            events: {
                'touchstart .photos_container': '_handle_tstart_photos',
                'touchmove .photos_container': '_handle_tmove_photos',
                'touchend .photos_container': '_handle_tend_photos',
            },

            _handle_tstart_photos: function (event) {
                this.track_photo_touch(event.originalEvent);
            },

            _handle_tmove_photos: function (event) {
                this.pan_photo_view($(event.currentTarget), event.originalEvent);
            },

            _handle_tend_photos: function (event) {
                this.clear_photo_touch();
            },

            clear_photo_touch: function () {
                this._last_touch = undefined;
            },

            track_photo_touch: function (touchevent) {
                this._last_touch = { clientX: touchevent.touches[0].clientX };
            },

            pan_photo_view: function ($target, touchevent) {
                var touch = touchevent.touches[0];
                var deltaX = this._last_touch.clientX - touch.clientX;

                if (deltaX > 0) { // opening
                    var $animating = $target.find('.animating.single_photo');
                    var $focused = $target.find('.visible.single_photo').last();

                    var right_edge = $focused.offset().left + $focused.width();
                    if (right_edge + deltaX < 300) {
                        $('.single_photo:not(.visible)').first().addClass('animating');
                    }
                    if (right_edge + deltaX < 10) {
                        $($animating[0]).removeClass('animating').addClass('visible');
                    }
                } else {
                    var $animating = $target.find('.animating.single_photo');
                    var $focused = $target.find('.visible.single_photo').last();
                    var $all_photos = $target.find('.single_photo');
                    var right_edge = $focused.offset().left + $focused.width();
                    if (right_edge + deltaX > 100 && $animating.length < 1 && !$all_photos.first().is($focused)) {
                        $focused.removeClass('visible').addClass('animating');
                    }
                    if (right_edge + deltaX > 300) {
                        $animating.removeClass('animating');
                    }
                }

                $target.width($target.width() + deltaX);
                this.track_photo_touch(touchevent);
            },

            initialize: function (options) {
                this.moments_raw = options.data;
            },

            render: function () {
                var moments_html = _.map(this.moments_raw, function (moment_raw) {
                    return this.render_moment(moment_raw);
                }, this).join('');
                this.$el.html(moments_html);

                var $photos_container = this.$('.photos_container');
                $photos_container.width($photos_container.parent().innerWidth());
                $photos_container.find('.single_photo:first-child').addClass('visible');
            },

            render_moment: function (moment_info) {
                var template = _.template($('#tpl_moment_single').html());
                return template({d: moment_info});
            }

        });

        var moments_raw;
        $(function () {
            var momentsview = new MomentsView({data: moments_raw, el: $('#moments_body_container')[0] });
            momentsview.render();
        });


        moments_raw = [{ username: 'leannagrand', members: ['gracetherope', 'karlinthehouse'], description: 'Summer fun as a raft guide. ::emoji::',
            posted_on: '2hrs', view_count: 12, comment_count: 5,
            photos: [
                { snaps: 2, src: 'moments_mobile/www/img/moments/leannagrand_1.jpg',
                  comments: [{ username: 'acanyon', comment: 'Best raft guide ever. Hope to visit again!'},
                             { username: 'acanyon', comment: 'Best raft guide ever. Hope to visit again!'}] },
                { snaps: 8, src: 'moments_mobile/www/img/moments/leannagrand_2.jpg',
                  comments: [] },
                { snaps: 0, src: 'moments_mobile/www/img/moments/leannagrand_3.jpg',
                  comments: [] },
            ]
        }];
    </script>
</html>

